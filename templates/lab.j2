apiVersion: v1
kind: Namespace
metadata:
  name: xebia-labs
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: xebia-labs-{{ username }}
  namespace: xebia-labs
spec:
  selector:
    matchLabels:
      app: xebia-labs-{{ username }}
  template:
    metadata:
      labels:
        app: xebia-labs-{{ username }}
    spec:
      containers:
      - name: xebia-labs-{{ username }}
        image: tiacloudconregdev.azurecr.io/vm-images/codeserver-tia-labs:v1.0.1
        command: ["/bin/bash", "-c"]
        args:
          - |
            sudo service docker start
            # cp -R /home/coder/project/.vscode /home/coder/project/
            kind create cluster --name {{ username }}-k8s-cluster --image=kindest/node:v1.26.6
            kubectl create namespace xebia-labs
            /usr/bin/code-server --auth password --host 0.0.0.0 --port 8080 .
        ports:
        - containerPort: 8080
        securityContext:
          privileged: true
        volumeMounts:
        - name: data-volume
          mountPath: /home/coder/project/.vscode
          subPath: ".vscode"
        - name: config
          mountPath: /home/coder/.config/code-server
          readOnly: true
      imagePullSecrets:
      -  name: acrcred-dev
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: pvc-tia-courses
      - name: config
        configMap:
          name: xebia-labs-{{ username }}-cm
      restartPolicy: Always
---
kind: Service
apiVersion: v1
metadata:
  name: xebia-labs-{{ username }}
  namespace: xebia-labs
spec:
  ports:
    - port: 4545
      targetPort: 8080
  selector:
    app: xebia-labs-{{ username }}
  type: LoadBalancer
#---

#apiVersion: networking.k8s.io/v1
#kind: Ingress
#metadata:
#  name: xebia-labs-{{ username }}-kong
#  namespace: xebia-labs
#  annotations:
#    kubernetes.io/ingress.class: "kong"
#spec:
#  rules:
#  - host: {{ username }}.xebia-labs.kong.dev.tiacloud.io
#    http:
#      paths:
#      - path: /
#        pathType: Prefix
#        backend:
#          service:
#            name: xebia-labs-{{ username }}
#            port:
#              number: 4545

---
apiVersion: v1
data:
  config.yaml: |-
      bind-addr: 127.0.0.1:8080
      auth: password
      password: {{ username }}-121
      cert: false
kind: ConfigMap
metadata:
  labels:
    app: xebia-labs-{{ username }}
  name: xebia-labs-{{ username }}-cm
  namespace: xebia-labs